<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Teste Simples da API</title>
</head>
<body>
    <h1>Teste da API NFDownload</h1>
    
    <div>
        <h2>Estado da API</h2>
        <p id="api-status">Aguardando verificação...</p>
    </div>
    
    <div style="margin-top: 20px;">
        <h2>Teste de Login</h2>
        <button id="test-login">Testar Login</button>
        <p id="login-status">Clique no botão para testar o login</p>
        <pre id="login-response" style="background: #f5f5f5; padding: 10px; margin-top: 10px;"></pre>
    </div>
    
    <div style="margin-top: 20px;">
        <h2>Teste de Pastas</h2>
        <button id="test-folders" disabled>Testar Pastas</button>
        <p id="folders-status">Faça login primeiro para testar as pastas</p>
        <pre id="folders-response" style="background: #f5f5f5; padding: 10px; margin-top: 10px;"></pre>
    </div>
    
    <div style="margin-top: 20px; padding: 15px; border: 1px solid #ccc; background: #f9f9f9;">
        <h3>Instruções Importantes:</h3>
        <p>1. Se você está vendo "Erro de Mixed Content" no console, é porque está tentando acessar uma API HTTP de uma página HTTPS</p>
        <p>2. O GitHub Pages usa HTTPS, mas sua API está em HTTP</p>
        <p>3. Para resolver isso, você precisa:</p>
        <ul>
            <li>Configurar sua API com HTTPS, OU</li>
            <li>Usar um serviço como ngrok para criar um túnel HTTPS, OU</li>
            <li>Testar localmente com HTTP em ambos os lados</li>
        </ul>
        <p>4. Para diagnóstico imediato, verifique o console do navegador (F12) para ver erros detalhados</p>
    </div>

    <script>
        // Configuração da API
        const API_CONFIG = {
            baseUrl: ' https://e89a73dd768e56f0653b36a64caa3713.loophole.site'
        };
        
        // Credenciais de teste
        const TEST_CREDENTIALS = {
            email: 'joao@empresa.com',
            password: 'senha123'
        };
        
        // Elementos do DOM
        const apiStatus = document.getElementById('api-status');
        const loginStatus = document.getElementById('login-status');
        const loginResponse = document.getElementById('login-response');
        const foldersStatus = document.getElementById('folders-status');
        const foldersResponse = document.getElementById('folders-response');
        const testLoginBtn = document.getElementById('test-login');
        const testFoldersBtn = document.getElementById('test-folders');
        
        // Verificar conexão com a API
        async function checkApiConnection() {
            try {
                apiStatus.textContent = 'Verificando conexão com a API...';
                
                // Primeiro, tentamos verificar o status de autenticação
                const response = await fetch(`${API_CONFIG.baseUrl}/auth/check`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    apiStatus.textContent = 'API acessível! Estado atual: ' + 
                        (data.authenticated ? 'AUTENTICADO' : 'NÃO AUTENTICADO');
                    return true;
                } else {
                    apiStatus.textContent = `Erro na API: ${response.status} ${response.statusText}`;
                    return false;
                }
            } catch (error) {
                apiStatus.textContent = `ERRO DE CONEXÃO: ${error.message}`;
                console.error('Detalhes do erro:', error);
                return false;
            }
        }
        
        // Testar login
        async function testLogin() {
            loginStatus.textContent = 'Enviando credenciais...';
            loginResponse.textContent = '';
            
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(TEST_CREDENTIALS),
                    mode: 'cors',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    loginStatus.textContent = 'Login realizado com sucesso!';
                    loginResponse.textContent = JSON.stringify(data, null, 2);
                    testFoldersBtn.disabled = false;
                    return true;
                } else {
                    loginStatus.textContent = `Falha no login: ${data.message || 'Credenciais inválidas'}`;
                    loginResponse.textContent = JSON.stringify(data, null, 2);
                    return false;
                }
            } catch (error) {
                loginStatus.textContent = `ERRO AO FAZER LOGIN: ${error.message}`;
                loginResponse.textContent = 'Verifique o console para detalhes';
                console.error('Erro detalhado no login:', error);
                return false;
            }
        }
        
        // Testar carregamento de pastas
        async function testFolders() {
            foldersStatus.textContent = 'Carregando estrutura de pastas...';
            foldersResponse.textContent = '';
            
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/auth/folders`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors',
                    credentials: 'include'
                });
                
                if (response.status === 401) {
                    foldersStatus.textContent = 'Erro: Não autenticado (faça login primeiro)';
                    return false;
                }
                
                const data = await response.json();
                
                if (response.ok) {
                    foldersStatus.textContent = 'Pastas carregadas com sucesso!';
                    foldersResponse.textContent = JSON.stringify(data, null, 2);
                    return true;
                } else {
                    foldersStatus.textContent = `Erro ao carregar pastas: ${response.status} ${response.statusText}`;
                    foldersResponse.textContent = JSON.stringify(data, null, 2);
                    return false;
                }
            } catch (error) {
                foldersStatus.textContent = `ERRO AO CARREGAR PASTAS: ${error.message}`;
                foldersResponse.textContent = 'Verifique o console para detalhes';
                console.error('Erro detalhado ao carregar pastas:', error);
                return false;
            }
        }
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Página carregada. Iniciando verificação da API...');
            
            // Verificar conexão com a API ao carregar a página
            checkApiConnection();
            
            // Event listeners
            testLoginBtn.addEventListener('click', testLogin);
            testFoldersBtn.addEventListener('click', testFolders);
            
            // Mensagem adicional no console para ajudar no diagnóstico
            console.log(`
                =====================================================
                INSTRUÇÕES PARA DIAGNÓSTICO:
                1. Se você vir "Failed to fetch" no console:
                   - Provavelmente é um problema de CORS ou Mixed Content
                2. Se você vir "Blocked by CORS Policy":
                   - A API não está configurada para aceitar requisições do seu domínio
                3. Se você vir "Mixed Content" warnings:
                   - Você está tentando acessar HTTP de uma página HTTPS
                4. Para resolver:
                   - Use HTTPS na API, OU
                   - Use ngrok para criar um túnel HTTPS, OU
                   - Teste localmente com HTTP em ambos os lados
                =====================================================
            `);
        });
    </script>
</body>
</html>
